<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link th:href="@{/style/main.css}" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <title>Lean Web App</title>

</head>
<body>
 <!-- The navigation menu -->
 <div nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
  <a href="/employee">Employees & Schedule</a>
  <a href="/process">Processes & Tasks</a>
  <a class="active" href="/gemba">Gemba</a>
  <a href="/dashboard">Dashboard</a>
</div> 
  

<!-- Gemba Calculations -->
<center><h2> Gemba Calculations </h2>
<hr>
<h5> <b>Select Process </b></h5><hr>
<div class="text-center">
  <select id="process-select" class="form-control form-control-lg">
    <option value="" disabled selected>Please Select The Process</option>
    <option th:each="process : ${processes}" th:value="${process.procID}" th:text="${process.procName}" style="text-align: center;"></option>
  </select>
  <br><hr>
  <h5><b>Stopwatch</b></h5><hr>
  <div id="stopwatch" class="text-center">
    <div class="time d-flex justify-content-center align-items-center">
      <b>
        <span id="minute" style="font-size: larger;">00</span>:
        <span id="second" style="font-size: larger;">00</span>:
        <span id="ms" style="font-size: larger;">00</span>
      </b>
    </div><br>
    <div class="d-flex justify-content-around mt-4">
      <button id="start" class="btn btn-primary mr-3" onclick="start();">Start</button>
      <button id="stop" class="btn btn-secondary mr-3" onclick="stop();">Stop</button>
      <button id="save" class="btn btn-success mr-3" onclick="save();">Save Time</button>
      <button id="restart" class="btn btn-danger" onclick="reset()">Reset</button>
    </div>
  </div>
</div>

<hr>

<!-- Table for  -->
<form>
<table id="taskTable" class="table table-striped" style="display: none">
  <tr>
    <th>Task ID</th>
    <th>Task Name</th>
    <th>Process Name</th>
    <th>Time of Task</th>
  </tr>
  <tr th:each="task : ${tasks}">
    <td th:text="${task.taskid}"></td>
    <td th:text="${task.taskname}"></td>
    <td th:text="${task.process.procName}" class="process-name"></td>
  
    <td class="time-of-task" id="time-of-task-{{task.taskid}}">NA</td>
  </tr>
  
</table>
<div class="form-group">

    <button type="submit" class="btn btn-primary">Save Times of Task for This Process</button>

</div>
</form>
<br>
<br>

<footer class="container-fluid bg-4 text-center">
  <section class="py-1">
    <div class="container px-4 px-lg-5 mt-5 bg-dark">
      <div class="row gx-4 gx-lg-5 justify-content-lg-start">
        <div class="col mb-5">
            <div class="card bg-dark text-white border-0">
                <div class="text-lg-start">
                    <b>Contact Details:</b><br>
                    <div class="text-lg-start">
                      <p>Phone : 087xxxx60</p>
                      <p>E-mail : 119717661@umail.ucc.ie</p>
                  </div>
                </div>
                <hr>
            </div>
      </div>
      <div class="col mb-5 float-right ms-auto">
        <div class="card h-10 bg-dark text-white border-0"></div>
      </div>
      </div>
    </div>
  </section>
  <div class="container py-4 bg-light">
    <p class="m-0 text-center text-black">Made for University College Cork &copy; <br> Created by: Piotr Janus</p>
  </div>
</footer>

<script type="text/javascript">

  // Selector 
  const select = document.querySelector('#process-select');
  const table = document.querySelector('.table');


  select.addEventListener('change', () => {
   
    table.style.display = '';

    const selectedProcess = select.options[select.selectedIndex].textContent;
    
    for (const row of table.rows) {
 
      const processCell = row.querySelector('.process-name');
      if (processCell) {
          if (processCell.textContent === selectedProcess) {
          row.style.display = '';
        } else {
           row.style.display = 'none';
        }
      }
    }
  });

//stopwatch

  var timer = 0;
  var timerInterval;
  var lapNum = 1;
  var ms = document.getElementById('ms');
  var second = document.getElementById('second');
  var minute = document.getElementById('minute');
  let currentRow = 0; 
  let isRunning = true;
  let startTime;

  function start() {
  document.getElementById("minute").innerHTML = "00";
  document.getElementById("second").innerHTML = "00";
  document.getElementById("ms").innerHTML = "00";
  timer = 0;

  clearInterval(timerInterval);

  timerInterval = setInterval(function() {
    timer += 1/60;
    msVal = Math.floor((timer - Math.floor(timer))*100);
    secondVal = Math.floor(timer) - Math.floor(timer/60) * 60;
    minuteVal = Math.floor(timer/60);
    ms.innerHTML = msVal < 10 ? "0" + msVal.toString() : msVal;
    second.innerHTML = secondVal < 10 ? "0" + secondVal.toString() : secondVal;
    minute.innerHTML = minuteVal < 10 ? "0" + minuteVal.toString() : minuteVal;
  }, 1000/60);
}

function stop() {
  if (isRunning) {
    clearInterval(timerInterval);
    isRunning = false;
    document.getElementById("stop").innerHTML = "Resume";
  } else {
    startTime = new Date();
    timerInterval = setInterval(function() {
      timer = ((new Date().getTime() - startTime.getTime()) / 1000);
      msVal = Math.floor((timer - Math.floor(timer))*100);
      secondVal = Math.floor(timer) - Math.floor(timer/60) * 60;
      minuteVal = Math.floor(timer/60);
      ms.innerHTML = msVal < 10 ? "0" + msVal.toString() : msVal;
      second.innerHTML = secondVal < 10 ? "0" + secondVal.toString() : secondVal;
      minute.innerHTML = minuteVal < 10 ? "0" + minuteVal.toString() : minuteVal;
    }, 1000/60);
    isRunning = true;
    document.getElementById("stop").innerHTML = "Stop";
  }
}

function reset() {
  clearInterval(timerInterval);

  timer = 0;
  document.getElementById("minute").innerHTML = "00";
  document.getElementById("second").innerHTML = "00";
  document.getElementById("ms").innerHTML = "00";
}

function save() {
  const selectedProcess = select.options[select.selectedIndex].textContent;

  const rows = table.rows;

  let nextRowIndex = currentRow;
  while (nextRowIndex < rows.length) {
    const processCell = rows[nextRowIndex].querySelector('.process-name');
    if (processCell && processCell.textContent === selectedProcess) {
      const elapsedTime = (parseInt(minute.textContent) * 60 + parseInt(second.textContent)) + (parseInt(ms.textContent) / 100);
      const timeCell = rows[nextRowIndex].querySelector('.time-of-task');
      timeCell.textContent = elapsedTime;
      currentRow = nextRowIndex + 1;
      break;
    }
    nextRowIndex += 1;
  }

  if (nextRowIndex >= rows.length) {
    currentRow = 0;
  }
  start();
}
</script>
</body>
</html>